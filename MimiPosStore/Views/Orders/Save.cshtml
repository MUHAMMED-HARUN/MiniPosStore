
@model SharedModels.EF.DTO.OrderDTO
@using SharedModels.EF.DTO
@{
    ViewData["Title"] = Model.ID == 0 ? "Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
}

@section Styles {
    <link rel="stylesheet" href="~/css/orders.css" />
}

<h1>@ViewData["Title"]</h1>

<!-- Toast container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<div class="row">
    <div class="col-md-8">
        <form asp-action="Save" method="post" id="orderForm">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <input hidden readonly asp-for="ID" />
            @(Model.OrderID=Model.ID)
            <input hidden readonly asp-for="OrderID" />

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="CustomerID" class="control-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select asp-for="CustomerID" class="form-control" asp-items="ViewBag.CustomerList">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option>
                        </select>
                        <span asp-validation-for="CustomerID" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="OrderDate" class="control-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
                        <input asp-for="OrderDate" class="form-control" type="date" />
                        <span asp-validation-for="OrderDate" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="TotalAmount" class="control-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                        <input asp-for="TotalAmount" class="form-control" readonly />
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="PaidAmount" class="control-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                        <input asp-for="PaidAmount" class="form-control" />
                        <span asp-validation-for="PaidAmount" class="text-danger"></span>
                    </div>
                </div>

           
            </div>

            <div class="form-group mb-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Ø­ÙØ¸
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                </a>
            </div>
        </form>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </h5>
            </div>
            <div class="card-body">
                <div id="customerInfo">
                    @if (Model.ID > 0 && !string.IsNullOrEmpty(Model.FirstName))
                    {
                        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> @(Model.FirstName + " " + Model.LastName)</p>
                        <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> @Model.PhoneNumber</p>
                    }
                    else
                    {
                        <p class="text-muted">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.ID > 0)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 d-flex gap-2">
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù…Ù†ØªØ¬
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addRawMaterialItemModal">
                            <i class="fas fa-flask"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù…Ø§Ø¯Ø© Ø®Ø§Ù…
                        </button>
                    </div>

                    <div id="orderItems">
                        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§ Ø¹Ø¨Ø± AJAX -->
                    </div>

                    <hr />

                    <div class="row">
                        <div class="col-md-3">
                            <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> <span id="totalAmount">@Model.TotalAmount @BAL.clsGlobal.GetCurrencyTypeString(1)</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> <span id="paidAmount">@Model.PaidAmount @BAL.clsGlobal.GetCurrencyTypeString(1)</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span id="remainingAmount" class="text-danger">@((Model.TotalAmount - Model.PaidAmount) + BAL.clsGlobal.GetCurrencyTypeString(1))</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±:</strong> <span id="itemsCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.ID > 0)
{
    @await Html.PartialAsync("_AddOrderItem", new OrderItemsDTO { OrderID = Model.ID })
    @await Html.PartialAsync("_EditOrderItem", new OrderItemsDTO { OrderID = Model.ID })
    @await Html.PartialAsync("_AddRawMaterialItem", new SharedModels.EF.Models.clsRawMaterialOrderItem { OrderID = Model.ID })
    @await Html.PartialAsync("_EditRawMaterialItem", new SharedModels.EF.Models.clsRawMaterialOrderItem { OrderID = Model.ID })
}




@section Scripts {


    <script src="/lib/zxing/zxing.min.js"></script>
    <script src="/lib/SignalR/signalr.min.js"></script>
    <script>
        // 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ SignalR
        const connection = window.setupSignalRConnection(
            "/barcodeHub", // Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø¨
            "ReceiveMessage", // Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø°ÙŠ ÙŠØ³ØªÙ‚Ø¨Ù„Ù‡ JS
            function(message) {
                console.log("ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ø³ØªÙ„Ù…Ø©:", message);
                alert("Received: " + message);
                document.getElementById("editProductSearch").value= message;
                document.getElementById("btnSearchProduct").click();
            }
        );

        // 2ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©
        window.startBarcodeScan('video', 'barcodeResult', 'scanbtn', function(scannedText) {
            console.log("ğŸ“¦ Barcode Scanned:", scannedText);

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ø¨Ø± SignalR
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 'TargetUserIdHere' Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø±Ø³Ø§Ù„ Ù…Ø­Ø¯Ø¯
            window.sendSignalRMessage(connection, "SendMessage", "TargetUserIdHere", scannedText);
        });
    </script>

    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        $(document).ready(function () {

            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
            var successMessage = '@TempData["SuccessMessage"]';
            if (successMessage) {
                showSuccessToast(successMessage);
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
            $('#CustomerID').change(function () {
                var customerId = $(this).val();
                if (customerId) {
                    // AJAX call Ù„Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                }
            });

            // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯
            @if (Model.ID > 0)
            {
                    <text>loadOrderItems();</text>
            }
        });

        // Toast Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­
        function showSuccessToast(message) {
            var toastHtml = `
                <div class="toast align-items-center text-white bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            $('#toastContainer').append(toastHtml);
            var toastElement = $('#toastContainer .toast:last')[0];
            var toast = new bootstrap.Toast(toastElement);
            toast.show();
            $(toastElement).on('hidden.bs.toast', function () { $(this).remove(); });
        }

        // ==== ÙˆØ¸Ø§Ø¦Ù Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨ ====

        function loadOrderItems() {
            var orderId = @Model.ID;
            $.get('/Orders/GetOrderItems', { orderId: orderId })
                .done(function (data) {
                    $('#orderItems').html(data);
                    updateOrderSummary();
                })
                .fail(function () {
                    $('#orderItems').html('<div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨</div>');
                });
        }

        function updateOrderSummary() {
            var totalAmount = 0;
            var totalDiscount = 0;
            var finalAmount = 0;
            var itemsCount = 0;

            $('.order-item-row').each(function () {
                var itemTotal = parseFloat($(this).find('.item-total').text().replace(/[^\d.-]/g, '')) || 0;
                var itemDiscount = parseFloat($(this).find('.item-discount').text().replace(/[^\d.-]/g, '')) || 0;
                var itemFinal = parseFloat($(this).find('.item-final').text().replace(/[^\d.-]/g, '')) || 0;
                
                totalAmount += itemTotal;
                totalDiscount += itemDiscount;
                finalAmount += itemFinal;
                itemsCount++;
            });

            $('#totalAmount').text(finalAmount.toFixed(2) + ' Ø¯.Ùƒ');
            $('#itemsCount').text(itemsCount);

            var paidAmount = parseFloat($('#PaidAmount').val()) || 0;
            var remainingAmount = finalAmount - paidAmount;
            $('#remainingAmount').text(remainingAmount.toFixed(2) + ' Ø¯.Ùƒ');

            $('#TotalAmount').val(finalAmount.toFixed(2));
        }

        function deleteItem(itemId, orderId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
                $.post('/Orders/DeleteItem', { itemId: itemId, orderId: orderId })
                    .done(function () { loadOrderItems(); })
                    .fail(function () { alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±'); });
            }
        }

        function deleteMaterialItem(itemId, orderId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…ØŸ')) {
                $.post('/Orders/DeleteMaterialItem', { itemId: itemId, orderId: orderId })
                    .done(function () { loadOrderItems(); })
                    .fail(function () { alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…'); });
            }
        }

        function editOrderItem(itemId, orderId) {
            $.get('/Orders/GetOrderItemForEdit', { itemId: itemId })
                .done(function (data) {
                    if (data.success) {
                        $('#editItemModal #ID').val(data.item.id);
                        $('#editItemModal #OrderID').val(data.item.orderID);
                        $('#editItemModal #editProductID').val(data.item.productID);
                        $('#editItemModal #editQuantityInput').val(data.item.quantity);
                        $('#editItemModal #availableQuantityDisplay').val(data.item.availableQuantity);
                        $('#editItemModal #editSellingPriceInput').val(data.item.sellingPrice);

                        if (data.item.productID) { loadEditProductInfo(data.item.productID); }
                        calculateEditItemTotal();
                        $('#editItemModal').modal('show');
                    } else {
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ØµØ±: ' + data.message);
                    }
                })
                .fail(function () { alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'); });
        }

        function editRawMaterialItem(itemId, orderId) {
            $.get('/Orders/GetMaterialItemForEdit', { itemId: itemId, orderId:orderId})
                .done(function (data) {
                    if (data.success) {
                        $('#editRawMaterialItemModal #rm_ID').val(data.item.id);
                        $('#editRawMaterialItemModal #rm_OrderID').val(data.item.orderID);
                        $('#editRawMaterialItemModal #rm_MaterialID').val(data.item.materialID);
                        $('#editRawMaterialItemModal #rm_MaterialName').val(data.item.name);
                        $('#editRawMaterialItemModal #rm_Quantity').val(data.item.quantity);
                        $('#editRawMaterialItemModal #rm_SellingPrice').val(data.item.sellingPrice);
                        $('#editRawMaterialItemModal #rm_WholesalePrice').val(data.item.wholesalePrice);
                        $('#editRawMaterialItemModal #rm_AvailableQuantity').val(data.item.availableQuantity);
                        $('#editRawMaterialItemModal #rm_UOMName').val(data.item.uomName);

                        var modal = new bootstrap.Modal(document.getElementById('editRawMaterialItemModal'));
                        modal.show();
                    } else {
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø§Ø¯Ø©: ' + data.message);
                    }
                })
                .fail(function () { alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'); });
        }

        $('#btnSaveRawMaterialItem').on('click', function () {
            var formData = $('#editRawMaterialItemForm').serialize();
            $.post('/Orders/UpdateMaterialItem', formData)
                .done(function (data) {
                    if (data.success) {
                        $('#editRawMaterialItemModal').modal('hide');
                        loadOrderItems();
                        showSuccessToast(data.message);
                    } else {
                        if (data.errors) {
                            alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                        } else {
                            alert(data.message || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø§Ø¯Ø©');
                        }
                    }
                })
                .fail(function () { alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); });
        });

        function loadEditProductInfo(productId) {
            $.get('/Orders/GetProductInfo', { productId: productId })
                .done(function (data) {
                    if (data.success) {
                        $('#editBasePrice').text(data.retailPrice + ' ' + data.currencyType);
                        $('#editAvailableQuantity').text(data.availableQuantity);
                        $('#editUnitOfMeasure').text(data.uomName);
                        $('#editAvailableQuantityDisplay').val(data.availableQuantity);
                    }
                });
        }

        function calculateEditItemTotal() {
            var quantity = parseFloat($('#editQuantityInput').val()) || 0;
            var price = parseFloat($('#editSellingPriceInput').val()) || 0;
            var total = quantity * price;
            $('#editItemTotalAmount').val(total.toFixed(2));
        }

    </script>
    <script src="~/js/Product.js" asp-append-version="true"></script>

}

