@model SharedModels.EF.DTO.ImportOrderItemDTO
 

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

<input type="hidden" asp-for="ImportOrderID" id="editImportOrderIdInput" />
<input type="hidden" asp-for="ImportOrderItemID" id="editImportOrderItemIdInput" />

<div class="row">
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="ProductID" class="control-label">المنتج</label>
            <div class="input-group">
                <input type="text" id="editProductSearch" class="form-control" placeholder="اكتب اسم المنتج" autocomplete="off" />
                <button class="btn btn-primary" type="button" id="btnSearchProduct">
                    <i class="fas fa-search"></i> بحث
                </button>
            </div>
            <input type="hidden" asp-for="ProductID" id="editProductID" />
            <div id="searchResults" class="list-group mt-1" style="max-height: 200px; overflow-y: auto;"></div>
            <span asp-validation-for="ProductID" class="text-danger"></span>
        </div>
    </div>

    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="Quantity" class="control-label">الكمية المستوردة</label>
            <input asp-for="Quantity" class="form-control" type="number" min="1" step="1" id="editQuantityInput" />
            <span asp-validation-for="Quantity" class="text-danger"></span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="SellingPrice" class="control-label">سعر الشراء</label>
            <input asp-for="SellingPrice" class="form-control" type="number" min="0" step="0.01" id="editSellingPriceInput" />
            <span asp-validation-for="SellingPrice" class="text-danger"></span>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label class="control-label">المبلغ الإجمالي للعنصر</label>
            <input type="text" class="form-control" id="editItemTotalAmount" readonly />
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>معلومات المنتج:</strong>
            <div id="editProductInfo">
                <p class="mb-1">السعر الأساسي: <span id="editBasePrice">-</span></p>
                <p class="mb-1">الكمية المتوفرة: <span id="editAvailableQuantity">-</span></p>
                <p class="mb-1">العملة: <span id="editCurrencyType">-</span></p>
                <p class="mb-0">وحدة القياس: <span id="editUnitOfMeasure">-</span></p>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    // البحث عن المنتج في نموذج التعديل
    $("#btnSearchProduct").click(function () {
        var searchTerm = $("#editProductSearch").val().trim();
        if (!searchTerm) return;

        $.ajax({
            url: '/Products/SearchProductByNmae',
            type: 'GET',
            dataType: 'json',
            data: { term: searchTerm },
            success: function (data) {
                var $results = $("#searchResults");
                $results.empty();

                if (!data || !data.id) {
                    $results.append('<div class="list-group-item">لا توجد نتائج</div>');
                    return;
                }

                // تعيين معرف المنتج في الحقل المخفي
                $('#editProductID').val(data.id);
                
                // تحميل معلومات المنتج
                loadEditProductInfo(data.id);
                
                // إخفاء نتائج البحث
                $results.empty();
            },
            error: function () {
                alert("حدث خطأ أثناء البحث.");
            }
        });
    });
    
    // تحميل معلومات المنتج في نموذج التعديل
    function loadEditProductInfo(productId) {
        // تعيين معرف المنتج في الحقل المخفي
        $('#editProductID').val(productId);
        
        $.get('/ImportOrders/GetProductInfo', { productId: productId })
            .done(function (data) {
                if (data.success) {
                    $('#editBasePrice').text(data.retailPrice + ' ' + data.currencyType);
                    $('#editAvailableQuantity').text(data.availableQuantity);
                    $('#editCurrencyType').text(data.currencyType);
                    $('#editUnitOfMeasure').text(data.uomName);
                    
                    // حساب المبلغ الإجمالي
                    calculateEditItemTotal();
                } else {
                    clearEditProductInfo();
                    alert('خطأ في تحميل معلومات المنتج: ' + data.message);
                }
            })
            .fail(function () {
                clearEditProductInfo();
                alert('حدث خطأ في الاتصال بالخادم');
            });
    }
    
    function clearEditProductInfo() {
        $('#editBasePrice').text('-');
        $('#editAvailableQuantity').text('-');
        $('#editCurrencyType').text('-');
        $('#editUnitOfMeasure').text('-');
        $('#editSellingPriceInput').val('');
        $('#editItemTotalAmount').val('');
        $('#editProductID').val(''); // مسح معرف المنتج
    }
    
    // حساب المبلغ الإجمالي عند تغيير الكمية أو السعر
    $('#editQuantityInput, #editSellingPriceInput').on('input', function () {
        calculateEditItemTotal();
    });
    
    function calculateEditItemTotal() {
        var quantity = parseFloat($('#editQuantityInput').val()) || 0;
        var sellingPrice = parseFloat($('#editSellingPriceInput').val()) || 0;
        var total = quantity * sellingPrice;
        $('#editItemTotalAmount').val(total.toFixed(2));
    }
    
    // تحميل بيانات العنصر عند فتح Modal التعديل
    function loadEditItemData(itemId) {
        $.get('/ImportOrders/GetImportOrderItemForEdit', { itemId: itemId }, function (data) {
            if (data.success) {
                $('#editImportOrderIdInput').val(data.item.importOrderID);
                $('#editImportOrderItemIdInput').val(data.item.importOrderItemID);
                $('#editProductID').val(data.item.productID);
                $('#editQuantityInput').val(data.item.quantity);
                $('#editSellingPriceInput').val(data.item.sellingPrice);
                
                // تحميل معلومات المنتج
                if (data.item.productID) {
                    loadEditProductInfo(data.item.productID);
                }
                
                // حساب المبلغ الإجمالي
                calculateEditItemTotal();
            }
        });
    }
    
    // تفعيل تحميل البيانات عند فتح Modal
    $('#editItemModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var itemId = button.data('item-id');
        loadEditItemData(itemId);
    });
});
</script>
