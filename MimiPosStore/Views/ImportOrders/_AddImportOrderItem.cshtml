@model BAL.BALDTO.ImportOrderItemBALDTO
@using BAL.BALDTO;

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

<input type="hidden" asp-for="ImportOrderID" id="importOrderIdInput" />
<input type="hidden" asp-for="ImportOrderItemID" value="0" />

<div class="row">
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="ProductID" class="control-label">المنتج</label>
            <select asp-for="ProductID" class="form-control" asp-items="ViewBag.ProductList" id="productSelect">
                <option value="">-- اختر المنتج --</option>
            </select>
            <span asp-validation-for="ProductID" class="text-danger"></span>
        </div>
    </div>
    <div class="form-group mb-3">
        <label asp-for="ProductID" class="control-label">المنتج</label>
        <div class="input-group">
            <input type="text" id="editProductSearch" class="form-control" placeholder="اكتب اسم المنتج" autocomplete="off" />
            <button class="btn btn-primary" type="button" id="btnSearchProduct">
                <i class="fas fa-search"></i> بحث
            </button>
        </div>
        <input type="hidden" asp-for="ProductID" id="editProductID" />
        <div id="searchResults" class="list-group mt-1" style="max-height: 200px; overflow-y: auto;"></div>
        <span asp-validation-for="ProductID" class="text-danger"></span>
    </div>

    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="Quantity" class="control-label">الكمية المستوردة</label>
            <input asp-for="Quantity" class="form-control" type="number" min="1" step="1" id="quantityInput" />
            <span asp-validation-for="Quantity" class="text-danger"></span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label asp-for="SellingPrice" class="control-label">سعر الشراء</label>
            <input asp-for="SellingPrice" class="form-control" type="number" min="0" step="0.01" id="sellingPriceInput" />
            <span asp-validation-for="SellingPrice" class="text-danger"></span>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="form-group mb-3">
            <label class="control-label">المبلغ الإجمالي للعنصر</label>
            <input type="text" class="form-control" id="itemTotalAmount" readonly />
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>معلومات المنتج:</strong>
            <div id="productInfo">
                <p class="mb-1">السعر الأساسي: <span id="basePrice">-</span></p>
                <p class="mb-1">الكمية المتوفرة: <span id="availableQuantity">-</span></p>
                <p class="mb-1">العملة: <span id="currencyType">-</span></p>
                <p class="mb-0">وحدة القياس: <span id="unitOfMeasure">-</span></p>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    // تعيين ImportOrderID
    var importOrderId = @Model.ImportOrderID;
    $('#importOrderIdInput').val(importOrderId);
    
    // تحديث معلومات المنتج عند تغيير المنتج
    $('#productSelect').change(function () {
        var productId = $(this).val();
        if (productId) {
            $.get('/ImportOrders/GetProductInfo', { productId: productId }, function (data) {
                if (data.success) {
                    $('#basePrice').text(data.retailPrice + ' ' + data.currencyType);
                    $('#availableQuantity').text(data.availableQuantity);
                    $('#currencyType').text(data.currencyType);
                    $('#unitOfMeasure').text(data.uomName);
                    
                    // تعيين سعر البيع الافتراضي
                    $('#sellingPriceInput').val(data.retailPrice);
                    
                    // حساب المبلغ الإجمالي
                    calculateItemTotal();
                } else {
                    $('#productInfo').html('<p class="text-danger">خطأ في تحميل معلومات المنتج</p>');
                }
            });
        } else {
            $('#productInfo').html('<p class="mb-1">السعر الأساسي: <span id="basePrice">-</span></p>' +
                                 '<p class="mb-1">الكمية المتوفرة: <span id="availableQuantity">-</span></p>' +
                                 '<p class="mb-1">العملة: <span id="currencyType">-</span></p>' +
                                 '<p class="mb-0">وحدة القياس: <span id="unitOfMeasure">-</span></p>');
        }
    });
    
    // حساب المبلغ الإجمالي عند تغيير الكمية أو السعر
    $('#quantityInput, #sellingPriceInput').on('input', function () {
        calculateItemTotal();
    });
    
    function calculateItemTotal() {
        var quantity = parseFloat($('#quantityInput').val()) || 0;
        var sellingPrice = parseFloat($('#sellingPriceInput').val()) || 0;
        var total = quantity * sellingPrice;
        $('#itemTotalAmount').val(total.toFixed(2));
    }
});
</script>
